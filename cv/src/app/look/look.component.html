<div class="dashboard">
  <!-- Header -->
  <header class="head">
    <div class="head-left">
      <h2>Suivi dépenses — {{ monthLabel }}</h2>
      <p class="muted">
        <strong>
          {{ (monthTotal$ | async) | currency:'EUR':'symbol':'1.2-2':'fr-FR' }}
        </strong>
        · {{ (monthCount$ | async) || 0 }} opération(s)
      </p>
    </div>

    <div class="toolbar">
      <!-- Toggle quotient/cumulé -->
      <div class="segmented small" role="tablist" aria-label="Mode courbe">
        <button role="tab"
                [attr.aria-selected]="curveMode()==='daily'"
                [class.active]="curveMode()==='daily'"
                (click)="curveMode.set('daily')">Quotidien</button>
        <button role="tab"
                [attr.aria-selected]="curveMode()==='cum'"
                [class.active]="curveMode()==='cum'"
                (click)="curveMode.set('cum')">Cumulé</button>
      </div>

      <!-- Onglets vues -->
      <div class="segmented" role="tablist" aria-label="Changer de vue">
        <button role="tab"
                [attr.aria-selected]="view()==='curve'"
                [class.active]="view()==='curve'"
                (click)="changeView('curve')">Courbe</button>
        <button role="tab"
                [attr.aria-selected]="view()==='categories'"
                [class.active]="view()==='categories'"
                (click)="changeView('categories')">Catégories</button>
      </div>

      <!-- Bouton form -->
      <button class="primary ghost" (click)="toggleForm()">
        {{ isFormOpen() ? 'Fermer' : 'Ajouter une dépense' }}
      </button>
    </div>
  </header>

  <!-- Graph en grand + formulaire coulissant -->
  <section class="card grid-2" [class.form-open]="isFormOpen()">
    <!-- GRAPHE -->
    <div class="panel graph-panel">
      <h3>Vue graphique</h3>
      <div class="chart-wrap">
        <ng-container [ngSwitch]="view()">
          <canvas *ngSwitchCase="'curve'" #curveCanvas></canvas>
          <canvas *ngSwitchCase="'categories'" #barCanvas></canvas>
        </ng-container>
      </div>
    </div>

    <!-- FORMULAIRE -->
    <div class="panel form-panel" [class.hidden]="!isFormOpen()">
      <h3>Ajouter une dépense</h3>
      <form [formGroup]="form" (ngSubmit)="addExpense()" class="frm">
        <div class="row2">
          <label>
            <span>Montant (€)</span>
            <input type="number" step="0.01" formControlName="amount" placeholder="0,00" />
          </label>

          <label>
            <span>Catégorie</span>
            <select formControlName="category">
              <option *ngFor="let c of categories" [value]="c.key">{{ c.label }}</option>
            </select>
          </label>

          <label>
            <span>Date</span>
            <input type="date" formControlName="dateStr" />
          </label>

          <label class="full">
            <span>Note</span>
            <input type="text" formControlName="note" placeholder="(optionnel)" />
          </label>
        </div>

        <div class="actions">
          <button class="primary" type="submit" [disabled]="saving() || form.invalid">
            <span *ngIf="!saving()">Ajouter</span>
            <span *ngIf="saving()" class="spinner" aria-hidden="true"></span>
          </button>
          <span class="error" *ngIf="errorMsg()">{{ errorMsg() }}</span>
        </div>
      </form>
    </div>
  </section>

  <!-- Liste -->
  <section class="card">
    <div class="card-head">
      <h3>Mouvements (mois courant)</h3>
    </div>

    <ng-container *ngIf="monthExpenses$ | async as rows">
      <ul class="list">
        <li class="item" *ngFor="let e of (rows || [])">
          <div class="meta">
            <div class="cat">{{ e.category }}</div>
            <div class="sub">
              {{ e.date.toDate() | date:'EEE d MMM, HH:mm':'':'fr-FR' }}
              <span *ngIf="e.note">· {{ e.note }}</span>
            </div>
          </div>

          <div class="amount">
            <strong>{{ e.amount | currency:'EUR':'symbol':'1.2-2':'fr-FR' }}</strong>
            <button class="link danger" (click)="delete(e.id)">supprimer</button>
          </div>
        </li>

        <li class="empty" *ngIf="(rows || []).length === 0">
          Aucune dépense à afficher.
        </li>
      </ul>
    </ng-container>
  </section>
</div>
